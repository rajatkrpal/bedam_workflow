# bedam python class
__doc__="""
$Revision: 0.1 $

A class to prepare BEDAM AsyncRE jobs

"""
# Contributors: Emilio Gallicchio, Junchao Xia

import os, sys, time, re, glob
from schrodinger.utils import cmdline
import schrodinger.utils.log
import shutil
import signal
import glob
import time

import sqlite3 as lite

from math import *

from bedam_prep_ac import bedam_prep_ac

class bedam_job_asyncre(bedam_prep_ac):
    """
    Class to set up BEDAM calculations
    """
    def __init__(self, command_file, options):
        bedam_prep_ac.__init__(self, command_file, options)

#
# Impact input file templates for academic
#
    def setupTemplatesASyncRE(self):
        """ Setup templates for input files for academic impact"""
        self.input_cms =  """
task {
  task = "desmond:auto"
}

build_geometry {
  box = {
     shape = "orthorhombic"
     size = [10.0 10.0 10.0 ]
     size_type = "absolute"
  }
  neutralize_system = false
  rezero_system = false
  solvate_system = false
}

assign_forcefield {
}

"""  

        self.input_idx =  """
write file -
"{out_file}" -
      title -
"{title}" *

CREATE
  build primary name species1 type auto read sqldb file -
"{dms_rcpt_in}"
  build primary name species2 type auto read sqldb file -
"{dms_lig_in}"
QUIT

SETMODEL
  setpotential
    mmechanics consolv agbnp2
  quit
  read parm file -
"paramstd.dat" -
  noprint
  energy parm dielectric 1 nodist -
   listupdate 10 -
    cutoff 12 hmass 5
  energy rescutoff byatom all
  zonecons auto
  energy constraints bonds hydrogens
QUIT

MINIMIZE
  input cntl mxcyc 0  rmscut 0.05 deltae 1.0e-05
  conjugate dx0 0.05 dxm 1.0
  run
  write sql name species1 file "{dms_rcpt_out}"
  write sql name species2 file "{dms_lig_out}"
QUIT

END
"""
        self.input_mintherm = """
write file -
"{out_file}" -
      title -
"{title}" *

CREATE
  build primary name species1 type auto read sqldb file -
"{dms_rcpt_in}"
  build primary name species2 type auto read sqldb file -
"{dms_lig_in}"
QUIT

SETMODEL
  setpotential
    mmechanics consolv agbnp2
  quit
  read parm file -
"paramstd.dat" -
  noprint
  energy rest domain cmdist kdist {cmkf} dist0 {cmdist0} toldist {cmtol} -
      read file "{cmrestraints_file}"
  energy parm dielectric 1 nodist -
   listupdate 10 -
    cutoff 12 hmass 5
  energy rescutoff byatom all
  zonecons auto
  energy constraints bonds hydrogens
QUIT

MINIMIZE
  conjugate dx0 5.000000e-02 dxm 1.000000e+00
  input cntl mxcyc 200 rmscut 1.000000e-02 deltae 1.000000e-07
  run
QUIT

put 100 into 'temp0'
put {temperature} into 'tempt'
put 10 into 'n'
put 'tempt'- 'temp0' into 'dtemp'
put 'dtemp' / 'n' into 'dt'

put 0 into 'i'
while 'i' lt 'n'

DYNAMICS
  input cntl nstep 1000 delt 0.0005
  input cntl constant totalenergy
  input cntl initialize temperature at 'temp0'
  input cntl nprnt 100
  input cntl tol 1.00000e-07
  input cntl stop rotations
  input cntl statistics off
  run rrespa fast 8
QUIT

put 'temp0' + 'dt' into 'temp0'
put 'i' + 1 into 'i'

endwhile

DYNAMICS
  write restart coordinates formatted file "{rst_file_out}"  
  write sql name species1 file "{dms_rcpt_out}"
  write sql name species2 file "{dms_lig_out}"
QUIT

END
"""
        self.input_remd = """
write file -
"{job_name}_@n@.out" -
      title -
"{job_name}" *

CREATE
  build primary name species1 type auto read sqldb file -
"{dms_rcpt_in}"
  build primary name species2 type auto read sqldb file -
"{dms_lig_in}"
QUIT

SETMODEL
  setpotential
    mmechanics nb12softcore umax {umax0} consolv agbnp2
    weight constraints buffer {rest_kf}
    weight bind rxid 0 nrep 1 lambda -
@lambda@
  quit
  read parm file -
"paramstd.dat" -
  noprint
  energy rest domain cmdist kdist {cmkf} dist0 {cmdist0} toldist {cmtol} -
      read file "{cmrestraints_file}"
  energy parm dielectric 1 nodist -
   listupdate 10 -
    cutoff 12 hmass 5
  energy rescutoff byatom all
  zonecons auto
  energy constraints bonds hydrogens
QUIT

if @n@ eq 1
DYNAMICS
  input target temperature @temperature@
  input cntl initialize temperature at @temperature@
QUIT
endif

!equilibration at new state
DYNAMICS
  input cntl nstep {nmd_eq} delt 0.0005
  input cntl constant temperature langevin relax 0.25
  input target temperature @temperature@
  input cntl nprnt {nmd_eq}
  input cntl tol 1.00000e-07
  input cntl stop rotations
  input cntl statistics off
  run rrespa fast 8
QUIT

DYNAMICS
  input cntl nstep {nmd} delt 0.001
  input cntl constant temperature langevin relax 1.0
  input target temperature @temperature@
  input cntl nprnt {nprnt}
  input cntl tol 1.00000e-07
  input cntl stop rotations
  input cntl statistics off
  run rrespa fast 4
  write restart coordinates and velocities formatted file "{job_name}_@n@.rst"
  write sql file "{job_name}_rcpt_@n@.dms" name species1
  write sql file "{job_name}_lig_@n@.dms" name species2
QUIT


END
"""


	self.input_remd_boinc = """
write file -
"md.out" -
      title -
"md" *

CREATE
  build primary name species1 type auto read sqldb file -
"md-in1.dms"
  build primary name species2 type auto read sqldb file -
"md-in2.dms"
QUIT

SETMODEL
  setpotential
    mmechanics nb12softcore umax {umax0} consolv agbnp2
